---
lab:
    title: '实验室：使用 Azure 中的服务创建多层解决方案'
    module: '模块 6：连接并使用 Azure 和第三方服务'
---

# 实验室：使用 Azure 中的服务创建多层解决方案
# 学生实验室手册

## 实验室应用场景

贵公司在你的各种解决方案中用例中成功采用并使用了 Microsoft Azure 搜索。在最新解决方案中，贵公司将数据存储在 Azure 存储表中，并需要使用 Azure 搜索为该表编制索引。为此，你将使用最少的代码构建 API。此解决方案有两个主要要求。首先，发布 REST 查询的开发人员不应通过任何细节了解 Azure 搜索正在幕后使用。其次，开发人员应能够使用简单的 REST 查询向表中添加新记录。你已决定使用 Azure 搜索、Azure API 管理和 Azure 逻辑应用来构建满足所有这些要求的最小代码解决方案。

## 目标

完成本实验室后，你将能够：

  - 创建 Azure 搜索帐户。

  - 手动创建 Azure 搜索索引。

  - 创建索引器以自动分析数据源中的数据。

  - 创建 API 管理帐户。

  - 使用标题替换和有效负载操作将 API 配置为另一个 Azure 服务的代理。

  - 创建逻辑应用资源。

  - 配置由 HTTP 请求触发的工作流。

## 实验室设置

  - **预计用时**：105 分钟

## 说明

### 开始前

#### 登录实验室虚拟机

  - 确保已使用以下凭据登录到 **Windows 10** 虚拟机：
    
      - **用户名**：Admin
    
      - **密码**：Pa55w.rd

#### 查看已安装的应用

  - 观察位于 **Windows 10** 桌面底部的任务栏。任务栏包含将在本实验室中使用的应用程序图标：
    
      - Microsoft Edge
    
      - 文件资源管理器
    
      - Microsoft Azure 存储资源管理器

#### 下载实验室文件

1.  在任务栏上，选择 **Windows PowerShell** 图标。

2.  在 PowerShell 命令提示符中，将当前工作目录更改为 **Allfiles (F):\\** 路径：

    ```
    cd F:
    ```

3.  在命令提示符中，输入以下命令并按 Enter 键以将 GitHub 上托管的 **microsoftlearning/AZ-203-DevelopingSolutionsForAzure** 项目克隆到 **Labfiles** 目录：

    ```
    git clone --depth 1 --no-checkout https://github.com/microsoftlearning/AZ-203-DevelopingSolutionsForMicrosoftAzure .
    ```

4.  在命令提示符中，输入以下命令并按 **Enter** 键以签出完成 **AZ-203.02** 实验室所必需的实验室文件：

    ```
    git checkout master -- Allfiles/*
    ```

5.  关闭当前正在运行的 **Windows PowerShell** 命令提示应用程序。

### 练习 1：在门户中创建 Azure 搜索服务

#### 任务 1：打开 Azure 门户

1.  登录至 [**Azure 门户**](https://portal.azure.com) (portal.azure.com)。

2.  如果这是你第一次登录 Azure 门户，则会显示一个对话框，提供门户教程。选择“**开始使用**”跳过教程。

#### 任务 2：创建 Azure 搜索帐户

1.  使用以下详细信息创建一个新的 **Azure 搜索**实例：
    
      - **名称**：prodsearch*\[your name in lowercase\]*
    
      - **新资源组**：MultiTierService
    
      - **位置**：美国东部
    
      - **定价层**：基本

> > **注**：等待 Azure 完成创建 Azure 搜索帐户再继续本实验室。Azure 搜索帐户创建时你会收到通知。

2.  访问新创建的“**Azure 搜索**”实例的“**密钥**”边栏选项卡。

3.  记录其中一个**搜索密钥**。你将稍后在实验室中使用此值。

#### 任务 3：创建索引

1.  访问你之前在本实验室中创建的 **prodsearch\*** 搜索服务。

2.  在“**搜索服务**”边栏选项卡中，选择“**添加索引**”。

3.  使用以下详细信息创建一个新的索引：
    
      - **索引名称**：retail
    
      - **密钥**：id

4.  使用下表配置索引字段：

| **字段**        | **类型**   | **可检索** | **可筛选** | **可排序** | **可查找** | **可搜索** | **分析器**          |
| ---------------- | ---------- | --------------- | -------------- | ------------ | ------------- | -------------- | --------------------- |
| **id**           | Edm.String | **✓**           |                | **✓**        |               |                |                       |
| **名称**         | Edm.String | **✓**           |                | **✓**        |               | **✓**          | **标准 - Lucene** |
| **价格**        | Edm.Double | **✓**           | **✓**          | **✓**        | **✓**         |                |                       |
| **数量**     | Edm.Int32  | **✓**           | **✓**          | **✓**        | **✓**         |                |                       |
| **制造商** | Edm.String | **✓**           | **✓**          | **✓**        | **✓**         |                |                       |

#### 回顾

在本练习中，你创建了一个新的 Azure 存储帐户并在该帐户中构建了一个索引。

### 练习 2：在 Azure 搜索中为 Azure 存储表编制索引

#### 任务 1：创建 Azure 存储帐户

1.  在 Azure 门户中，使用以下详细信息创建一个新的**存储帐户**：
    
      - **现有****资源****组**：MultiTierService
    
      - **名称**：prodstorage*\[your name in lowercase\]*
    
      - **位置**：美国东部
    
      - **性能**：标准
    
      - **帐户** **类型**：StorageV2（通用 v2）
    
      - **复制**：读取访问地域冗余存储 (RA-GRS)
    
      - **访问****层**：热

> > **注**：等待 Azure 完成创建存储帐户再继续本实验室。帐户创建时你会收到通知。

2.  访问新创建的“**存储帐户**”实例的“**访问密钥**”边栏选项卡。

3.  记录“**连接字符串**”字段的值。你将稍后在本实验室中使用此值。

#### 任务 2：将表实体上传到 Azure 存储

1.  访问之前在本实验室中创建的 **prodstorage\*** 存储帐户。

2.  在“**表服务**”部分，选择“**表**”链接。

3.  使用以下设定创建一个新的**表**：
    
      - **名称**：products

4.  在边栏选项卡的“**概观**”部分，选择“**在资源管理器中打开**”以使用 **Azure 存储资源管理器**打开存储帐户。

5.  在显示的 **Azure 存储资源管理器**应用程序中，在你之前在本实验室中创建的 **prodstorage\*** 存储帐户中，找到并打开 **products** 表。

6.  在“**产品表**”选项卡中，选择“**导入**”并导入位于实验室机器 **Allfiles (F):\\Labfiles\\Starter** 文件夹的 **products.csv** 文件。

#### 任务 3：创建 Azure 搜索索引器

1.  访问你之前在本实验室中创建的 **prodsearch\*** 搜索服务。

2.  在“**搜索服务**”边栏选项卡中，选择“**导入数据**”。

3.  在“**导入数据**”边栏选项卡中，使用以下详细信息创建一个新的索引器：
    
      - **数据源**：Azure 表存储
    
      - **数据源名称**：tabledatasource
    
      - **连接字符串**：\<*选择之前在本实验室中创建的 **prodstorage\*** 存储帐户\>*
    
      - **表名称**：products
    
      - **索引名称**：products
    
      - **密钥**：RowKey
    
      - 使用下表配置索引字段：

| **字段**    | **类型**   | **可检索** | **可筛选** | **可排序** | **可查找** | **可搜索** | **分析器**          |
| ------------ | ---------- | --------------- | -------------- | ------------ | ------------- | -------------- | --------------------- |
| **密钥**      | Edm.String | **✓**           |                | **✓**        |               |                |                       |
| **名称**     | Edm.String | **✓**           |                | **✓**        |               | **✓**          | **标准 - Lucene** |
| **价格**    | Edm.Double | **✓**           | **✓**          | **✓**        | **✓**         |                |                       |
| **数量** | Edm.Int32  | **✓**           | **✓**          | **✓**        | **✓**         |                |                       |

  - **索引器** **名称**：tableindexer

  - **计划**：自定义

  - **间隔**：5

<!-- end list -->

4.  手动**运行** 你刚刚在本实验室中创建的 **tableindexer** 索引器。

5.  观察 **tableindexer** 索引器的元数据及其最近运行。元数据包括如文档计数和上次索引操作的状态等信息。你将观察到上次索引操作成功并将多个文档添加到索引中。

#### 任务 4：验证索引表数据

1.  为之前在本实验室中创建的 **prodsearch\*** 搜索服务打开 **搜索浏览器**。

2.  通过将所有字段保留设置为其默认（空）值并选择“**Enter**”来执行空查询。观察此查询的结果返回索引中所有文档的结果页面。

3.  执行以下查询并观察结果：

<!-- end list -->

    search=seat

4.  执行以下查询并观察结果：

<!-- end list -->

    $filter=price lt 100

5.  执行以下查询并观察结果：

<!-- end list -->

    facet=quantity,interval:25

6.  执行以下查询并观察结果：

<!-- end list -->

    $filter=quantity gt 25&facet=price,values:100|1000|10000

#### 任务 5：检索 Azure 搜索基本 URL

1.  访问你之前在本实验室中创建的 **prodsearch\*** 搜索服务。

2.  在“**搜索服务**”边栏选项卡，复制“**URL**”字段的值。你将稍后在实验室中使用此值。

#### 回顾

在本练习中，你使用 Azure 搜索创建了 Azure 存储帐户并在帐户中为存储表创建了索引。为表创建索引后，您可以对存储表中的实体副本发出搜索查询。

### 练习 3：使用 Azure API 管理构建 API 代理层

#### 任务 1：创建 API 管理资源

> 在 Azure 门户中，使用以下详细信息创建一个新的 **API 管理帐户**：

  - **现有** **资源** **组**：MultiTierService

  - **名称**：prodapi*\[your name in lowercase\]*

  - **位置**：美国东部

  - **组织名称**：Contoso

  - **定价** **层**：开发人员（无 SLA）

> > **注**：等待 Azure 完成创建 API 管理帐户再继续本实验室。帐户创建时你会收到通知。创建 API 管理服务通常需要 20 到 30 分钟。

#### 任务 2：定义一个新的 API

1.  访问之前在本实验室中创建的 **prodapi\*** API 管理帐户。

2.  查看新帐户的 **API** 列表。

> > **注**：所有新帐户都以简单的 **Echo API** 开始。

3.  使用以下详细信息创建一个新的**空白 API**：
    
      - **显示名称**：搜索 API
    
      - **Name**：search-api
    
      - **Web 服务 URL**：输入你之前在本实验室中复制的 **搜索服务 URL**。通过以下相关 URL 追加 **Web 服务 URL** 字段的值：

> 
> 
>     /indexes/products/docs
> 
> > **注**：例如，如果 Web 服务 URL 为 https://prodsearchstudent.search.windows.net，新的 URL 将为 https://prodsearchstudent.search.windows.net/indexes/products/docs。

  - **API URL 后缀**：search

  - **产品**：同时选择“**起动器**”和“**无限制**”选项。

<!-- end list -->

4.  将新的操作添加到使用以下信息新创建的 API：
    
      - **显示名称**：列出所有文档
    
      - **名称**：list-all-documents
    
      - **URL**：GET /

> 然后，选择“**保存**”。

5.  通过以下详细信息将新的“**设置标题**”入站策略添加到“**所有操作**”：
    
      - **名称**：api-key
    
      - **值**：输入你之前在本实验室中记录的搜索服务密钥值。

6.  通过以下详细信息将新的“**设置查询参数**”入站策略添加到“**所有操作**”：
    
      - **名称**：api-version
    
      - **值**：2017-11-11
    
      - **操作**：替代

7.  通过以下详细信息将新的“**设置查询参数**”入站策略添加到“**列出所有文档**”操作：
    
      - **名称**：search
    
      - **值**：*\**
    
      - **操作**：替代

8.  在**搜索 API** 中测试**列出所有文档**操作，观察 API 请求结果。

> > **注**：观察响应中是否存在大量 Azure 搜索元数据。你可能不希望 API 用户看到幕后发生的实现细节。在下一个任务中，你将混淆大部分此类数据。

#### 任务 3：操纵 API 响应

1.  通过以下详细信息将新的“**设置标题**”出站策略添加到“**所有操作**”：
    
    1.  **名称**：preference-applied
    
    2.  **操作**：删除

2.  通过以下详细信息将新的“**设置标题**”出站策略添加到“**所有操作**”：
    
    3.  **名称**：odata-version
    
    4.  **操作**：删除

3.  通过以下详细信息将新的“**设置标题**”出站策略添加到“**所有操作**”：
    
    5.  **名称**：powered-by
    
    6.  **值**：Contoso
    
    7.  **操作**：替代

<!-- end list -->

4.  通过先找到以下 XML 内容块，向“**列出所有文档**”操作添加一个新的自定义出站策略：

<!-- end list -->

    <outbound>
        <base />
    </outbound>

然后使用以下 XML 替换该 XML 块：

    <outbound>
        <base />
        <set-body>
        @{ 
            var response = context.Response.Body.As<JObject>();
            return response.Property("value").Value.ToString();
        }
        </set-body>
    </outbound>

5.  在 **搜索 API** 中测试 **列出所有文档** 操作，观察 API 请求结果。

> > **注**：你将观察到你指定的 **preference-applied** 和 **odata-version** 标题已被删除并被新的 **powered-by** 标题替换。你还将注意到响应不包含有关 OData 响应的上下文数据，而是包含平展 JSON 数组作为响应正文。

#### 回顾

在本练习中，你在 Azure 搜索帐户和任何希望进行搜索查询的开发人员之间构建了代理层。

### 练习 4：使用 Azure 逻辑应用创建新的表实体

#### 任务 1：创建逻辑应用资源

  - 在 Azure 门户中，使用以下详细信息创建一个新的 **逻辑应用**：
    
      - **现有** **资源** **组**：MultiTierService
    
      - **名称**：prodworkflow*\[your name in lowercase\]*
    
      - **位置**：美国东部
    
      - **日志分析**：关

> > **注**：等待 Azure 完成创建逻辑应用资源再继续本实验室。资源创建时你会收到通知。

#### 任务 2：创建逻辑应用工作流触发器

1.  在“**逻辑应用设计器**”边栏选项卡中，选择“**空白逻辑应用**”模板。

2.  在“**设计器**”区域，通过使用以下示例 JSON 文档生成 JSON 架构添加新的“**收到 HTTP 请求时**”触发器：

<!-- end list -->

    { 
        "id": "",
        "manufacturer": "",
        "price": 0.00,
        "quantity": 0,
        "name": ""
    }

#### 任务 3：构建 Azure 存储连接器

  - 在“**设计器**”区域，通过以下详细信息添加“**插入或替换”**实体操作：
    
      - **连接名称**：tableconnection
    
      - **存储帐户**：\<选择之前在本实验室中创建的 **prodstorage\*** 存储帐户\>
    
      - **表**：products
    
      - **分区键**：manufacturer（动态字段 - 收到 HTTP 请求时）
    
      - **行键**：id（动态字段 - 收到 HTTP 请求时）
    
      - **实体**：正文（动态字段 - 收到 HTTP 请求时）

#### 任务 4：构建 HTTP 响应操作

  - 在“**设计器**”区域，通过以下详细信息添加新的“**响应操作**”：
    
    1.  **状态代码**：201
    
    2.  **正文**：正文（动态字段 - 插入或替换实体）

#### 任务 5：检索 HTTP 触发器 POST URL

1.  在“**设计器**”区域，选择“**保存**”。

2.  保存工作流之后，“**收到 HTTP 请求时**”触发器中的“**HTTP POST URL**”字段将更新为启动此工作流所需的新 URL。复制“**HTTP POST URL**”字段中的 URL。你将稍后在实验室中使用此 URL。

> > **注**：此 URL 非常长，因为其包含 URL 和 SAS 令牌。确保复制整个 URL。

#### 任务 6：验证逻辑应用程序结果是否已编制索引

1.  打开一个新的 Azure Cloud Shell 实例。

2.  如果 Cloud Shell 尚未配置，请使用默认设置为 Bash 配置 Shell。

3.  在 Cloud Shell 命令提示符中，输入以下部分 **CURL** 命令以将 **HTTP POST** 请求发出到逻辑应用实例，然后按 Enter 键：

<!-- end list -->

    curl \
    --header "Content-Type: application/json" \
    --data '{"id":"6","manufacturer":"VEHTOP","price":750,"quantity":6,"name":"car roof rack"}' \

4.  然后，输入之前在本实验室中复制的逻辑应用 **HTTP POST URL**，确保将 URL 置于 **引号** 内，防止 URL 字符转义。按 **Enter** 键执行命令。

> > **注**：例如，如果 URL 为 https://prod.eastus.logic.azure.com:443/workflows/test/triggers/invoke?api-version=2016\&sig=3，则你将插入“https://prod.eastus.logic.azure.com:443/workflows/test/triggers/manual?invoke?api-version=2016\&sig=3”。如果不包含引号，则会收到一条错误消息，指出 SAS 令牌已被截断并且需要发出请求。这是由于查询字符串分隔符 **&** 导致的，如果不使用引号将其括起，则会被截断。

5.  访问你之前在本实验室中创建的 **prodsearch\*** 搜索服务。

6.  手动 **运行** 你刚刚在本实验室中创建的 **tableindexer** 索引器。

7.  为之前在本实验室中创建的 **prodsearch\*** 搜索服务打开 **搜索浏览器**。

8.  执行空查询并观察结果。

> > **注**：此时，您将注意到索引中的第六个文档，该文档表示逻辑应用插入的新文档。

7.  访问之前在本实验室中创建的 **prodapi\*** API 管理帐户。

8.  在 **搜索 API** 中测试 **列出所有文档** 操作，观察 API 请求结果。

> > **注**：观察到现在有六个文档而不是五个。

#### 回顾

在本练习中，你创建了一个接受 HTTP 请求，然后将请求的 JSON 正文保留为新的 Azure 存储表实体的逻辑应用。

### 练习 5：清理订阅 

#### 任务 1：打开 Cloud Shell

1.  在门户顶部，选择 **Cloud Shell** 图标打开一个新的 Shell 实例。

2.  在门户底部的 **Cloud Shell** 命令提示符下，输入以下命令并按 Enter 键以列出订阅中的所有资源组。

<!-- end list -->

    az group list

3.  输入以下命令，然后按 Enter 键查看删除资源组的可能命令列表：

<!-- end list -->

    az group delete --help

#### 任务 2：删除资源组

1.  输入以下命令，然后按 Enter 键删除 **MultiTierService** 资源组：

<!-- end list -->

    az group delete --name MultiTierService --no-wait --yes

2.  关闭门户底部的“**Cloud Shell**”窗格。

#### 任务 3：关闭活动应用程序

1.  关闭当前正在运行的 **Microsoft Edge** 应用程序。

2.  关闭当前正在运行的 **Microsoft Azure 存储资源管理器** 应用程序。

#### 回顾

在本练习中，你通过移除本实验室中使用过的 **资源组** 来清理订阅。
